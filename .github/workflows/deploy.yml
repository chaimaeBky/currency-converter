name: build & deploy to azure

on:
  push:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
  
    steps:
      - name: checkout repo
        uses: actions/checkout@v3

      - name: log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: build & push backend image
        run:
          docker build -t chaimaebky/currencyconverter-web:latest ../backend
          docker push chaimaebky/currencyconverter-web:latest

      - name: build & push frontend image
        run: 
          docker build -t chaimaebky/currencyconverter-frontend:latest ../frontend
          docker push chaimaebky/currencyconverter-frontend:latest

      - name: deploy backend to azure container instances 
        uses: azure/aci-deploy@v1
        with:
          resource-group: RGCurrency
          name: flask-backend
          image: chaimaebky/currencyconverter-web:latest
          cpu: 0.5
          memory: 0.5
          ports: 5000
          os-type: Linux
          registry-username: ${{ secrets.DOCKER_USERNAME }}
          registry-password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: deploy frontend to azure container instances
        uses: azure/aci-deploy@v1
        with:
          resource-group: RGCurrency
          name: react-frontend
          image: chaimaebky/currencyconverter-frontend:latest
          cpu: 0.5
          memory: 0.5
          ports: 80
          os-type: Linux
          registry-username: ${{ secrets.DOCKER_USERNAME }}
          registry-password: ${{ secrets.DOCKER_PASSWORD }}
              
          
  

